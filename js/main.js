angular.module("dashboard.controllers",["tc.chartjs","ngActivityIndicator"]).controller("DashboardCtrl",["$scope","$filter","$activityIndicator","DataService","ParseService","DateFactory","ChartDataService","OrderSchedulesFactory",function(e,r,t,n,a,c,s,d){var o=c.currentDay(),i=o.format("MM-DD-YY");e.charts={},e.globals={},e.scheduleString=" ",t.startAnimating(),n.getAllSchedules().then(function(t){return e.allSchedules=r("orderBy")(t.data,d,!0),e.scheduleObject=_.findWhere(t.data,{_id:i}),e.scheduleString=a.parseSchedule(e.scheduleObject),n.getAllUsers()}).then(function(r){return e.allUsers=r.data,e.userCount=a.countUsers(e.allUsers),e.charts.userGrades={data:s.parseUserGrades(e.userCount),options:{segmentShowStroke:!0,segmentStrokeColor:"#fff",segmentStrokeWidth:1}},n.getFeedbackItems()}).then(function(r){return e.feedbackItemsList=r.data,e.feedbackItems=a.countFeedback(e.allUsers,e.feedbackItemsList),e.feedbackItems=a.sortFeedbackItems(e.feedbackItems),e.charts.feedbackItems={data:s.parseFeedback(e.feedbackItems),options:{legendTemplate:'<ul class="tc-chart-js-legend display-none"></ul>'}},n.getVersions()}).then(function(t){e.versions=r("orderBy")(t.data,"versionNumber","reverse"),e.currentVersion=e.versions[0]}).finally(function(){t.stopAnimating()})}]).controller("AddScheduleCtrl",["$scope","DataService","ScheduleFactory","ParseService","dayLetters",function(e,r,t,n){e.addSchedule={},e.addSchedule.dayType="normal",e.errorMessage="",e.lastSchedule={},e.$watch("addSchedule.date",function(r){e.addSchedule.date=n.formatDate(r)}),e.$watch("addSchedule.firstPeriod",function(r){r=r||"",e.addSchedule.firstPeriod=r.replace(/[^a-g]+/g,"")}),e.$watchCollection("addSchedule",function(r){e.schedule=t.make(r)}),e.submit=function(){e.loading=!0,r.addSchedule(e.schedule).then(function(r){console.log(r),e.loading=!1}),e.addSchedule={},e.addSchedule.dayType="normal"}}]).controller("ScheduleCtrl",["$scope",function(e){e.currentScheduleId="",e.$watch("currentScheduleId",function(r){e.currentSchedule=_.findWhere(e.$parent.allSchedules,{_id:r})})}]).controller("UserCtrl",["$scope",function(e){e.currentUserId="",e.$watch("currentUserId",function(r){e.currentUser=_.findWhere(e.$parent.allUsers,{_id:r})})}]).controller("VersionsCtrl",["$scope","DataService",function(e,r){e.currentVersionNumber="",e.$watch("currentVersionNumber",function(r){e.currentVersion=_.findWhere(e.versions,{versionNumber:r})}),e.addVersion=function(){e.loading=!0;var t={versionNumber:e.newVersionNumber,date:"",changes:[]};r.addVersion(t).then(function(e){return r.getVersion(e.data.id)}).then(function(r){e.versions.unshift(r.data),e.newVersionNumber="",e.loading=!1})}}]).controller("EditVersionCtrl",["$scope","DataService",function(e,r){e.submit=function(){e.loading=!0,e.newChange&&(e.currentVersion.changes.push({value:e.newChange}),e.newChange=""),e.currentVersion.changes=_.filter(e.currentVersion.changes,function(e){return e.value});var t=angular.copy(e.currentVersion);r.updateVersion(t).then(function(r){e.currentVersion._rev=r.data.rev,e.loading=!1})}}]);
angular.module("dashboard",["dashboard.controllers","dashboard.services"]).constant("dbUrl","https://orgalaskelldintystarlinu:akEwnCIxXqksQdC8CqsyiSR2@schedu.cloudant.com/").constant("dayLetterColors",{A:"#D362E8",B:"#2ecc71",C:"#e67e22",D:"#9b59b6",E:"#e74c3c",F:"#f1c40f",G:"#3498db",Sp:"#34495e"}).constant("dayLetters",["a","b","c","d","e","f","g"]).directive("periodBlock",[function(){return{restrict:"EA",scope:{period:"="},replace:!0,link:function(e){e.period=1==e.period.length?e.period.toUpperCase():"Sp"},template:'<li class="period-block inline-block center {{period | lowercase}}-period">{{period}}</li>'}}]).directive("submitButton",[function(){return{restrict:"E",scope:{text:"@text",classes:"@classes"},replace:!0,templateUrl:"templates/submit-button.html"}}]).filter("titleCase",[function(){return function(e){return e=void 0===e||null===e?"":e,e.toString().toLowerCase().replace(/\b([a-z])/g,function(e){return e.toUpperCase()})}}]).filter("date",[function(){return function(e){if(!e)return"";var t=e,r=e.substring(0,2),n=e.substring(2,4),o=e.substring(4,6);return n&&(t=r+"-"+n),o&&(t+="-"+o),t}}]);
angular.module("dashboard.services",[]).service("DataService",["$q","dbUrl","ParseService",function(e,r,t){var a=new PouchDB(r+"user"),o=new PouchDB(r+"schedule"),n=new PouchDB(r+"feedback"),i=new PouchDB(r+"versions");this.getFeedbackItems=function(){var r=e.defer();return n.allDocs({include_docs:!0},function(e,a){null==e&&(e=!1),a=t.parseFeedbackItems(a.rows),r.resolve({data:a,error:e})}),r.promise},this.addFieldToUsers=function(){var r=e.defer();return a.allDocs({include_docs:!0},function(e,t){null==e&&(e=!1),_.each(t.docs,function(){}),r.resolve({data:t,error:e})}),r.promise},this.getAllUsers=function(){var r=e.defer();return a.allDocs({include_docs:!0},function(e,a){null==e&&(e=!1),a=t.simplifyAllDocs(a.rows),r.resolve({data:a,error:e})}),r.promise},this.getAllSchedules=function(){var r=e.defer();return o.allDocs({include_docs:!0},function(e,a){null==e&&(e=!1),a=t.simplifyAllDocs(a.rows),r.resolve({data:a,error:e})}),r.promise},this.getSchedule=function(r){var t=e.defer();return o.get(r,function(e,r){null==e&&(e=!1),t.resolve({data:r,error:e})}),t.promise},this.addSchedule=function(r){var t=e.defer();return o.put(r,r.id,function(e,r){null==e&&(e=!1),t.resolve({data:r,error:e})}),t.promise},this.getVersions=function(){var r=e.defer();return i.allDocs({include_docs:!0},function(e,a){null==e&&(e=!1),a=t.simplifyAllDocs(a.rows),r.resolve({data:a,error:e})}),r.promise},this.getVersion=function(r){var t=e.defer();return i.get(r,function(e,r){null==e&&(e=!1),t.resolve({data:r,error:e})}),t.promise},this.addVersion=function(r){var t=e.defer();return i.post(r,function(e,r){null==e&&(e=!1),t.resolve({data:r,error:e})}),t.promise},this.updateVersion=function(r){var t=e.defer();return i.put(r,r._id,r._rev,function(e,r){null==e&&(e=!1),t.resolve({data:r,error:e})}),t.promise}}]).service("ParseService",["$filter",function(e){this.parseSchedule=function(e){var r=!1;if(e.periodOrder){var t=e.periodOrder[0];1==t.length&&(t=t.toUpperCase(),r=t+e.dayNumber)}else e.holiday&&(r=e.holiday);return r},this.parseFeedbackItems=function(e){var r={};return _.each(e,function(e){r[e.id]={_id:e.id,name:e.doc.name,votes:e.doc.votes}}),r},this.sortFeedbackItems=function(r){var t=[];return _.each(r,function(e){t.push(e)}),t=e("orderBy")(t,"votes","reverse")},this.simplifyAllDocs=function(e){var r=[];return _.each(e,function(e){r.push(e.doc)}),r},this.findMissingSchedules=function(e,r){var t=moment();r=r||100;for(var a=0;r>a;a++)if(t.add(1,"days"),0!=t.day()&&6!=t.day()){var o=t.format("MM-DD-YY"),n=_.find(e,function(e){return e._id==o?!0:!1});console.log(n?t.day():"MISSING:"+o)}},this.countUsers=function(e){var r=_.where(e,{test:!0}),t={total:e.length-r.length,12:0,11:0,10:0,9:0,test:0,teacher:0};return _.each(e,function(e){e.grade&&e.test!==!0?t[e.grade.toString()]++:1==e.test&&t.test++}),t},this.countFeedback=function(e,r){return _.each(e,function(e){_.each(e.feedback.voteItems,function(e){r[e].votes++})}),r},this.formatDate=function(r){return r=r||"",r=r.replace(/[^0-9]+/g,""),r=e("date")(r)}}]).service("ChartDataService",[function(){this.parseUserGrades=function(e){var r=[{value:e[9],color:"hsla(283, 39%, 53%, 1)",highlight:"hsla(283, 39%, 53%, 0.75)",label:"freshmen"},{value:e[10],color:"hsla(6, 78%, 57%, 1)",highlight:"hsla(6, 78%, 57%, 0.75)",label:"sophomores"},{value:e[11],color:"hsla(48, 89%, 50%, 1)",highlight:"hsla(48, 89%, 50%, 0.75)",label:"juniors"},{value:e[12],color:"hsla(204, 70%, 53%, 1)",highlight:"hsla(204, 70%, 53%, 0.75)",label:"seniors"},{value:e.teacher,color:"hsla(145, 63%, 49%, 1)",highlight:"hsla(145, 63%, 49%, 0.75)",label:"teachers"},{value:e.test,color:"hsla(28, 80%, 52%, 1.0)",highlight:"hsla(28, 80%, 52%, 0.75)",label:"test"}];return r},this.parseFeedback=function(e){var r=[],t=[];_.each(e,function(e,a){r.push(a+1),t.push(e.votes)});var a={labels:r,datasets:[{fillColor:"hsla(115, 95%, 16%, 1)",data:t}]};return a}}]).factory("ScheduleFactory",["dayLetters","$filter",function(e,r){function t(r,t){if(r){for(var a=e;a[0]!=r;){var o=a[0];a.splice(0,1),a.push(o)}t&&a.splice(2,0,"Activity Period")}else a=!1;return a}return{make:function(e){var a={_id:e.date,special:e.dayType};if(e.dayNumber&&(a.dayNumber=e.dayNumber),"normal"==e.dayType||"activityperiod"==e.dayType){if("activityperiod"==e.dayType)var o=!0;else{var o=!1;a.special=!1}a.periodOrder=t(e.firstPeriod,o)}else e.periods?(a.periodOrder=_.compact(e.periods),_.each(a.periodOrder,function(e,t){1==e.length?a.periodOrder[t]=e.toLowerCase():e.length>1&&(a.periodOrder[t]=r("titleCase")(e))})):"holiday"==e.dayType?a.holiday=r("titleCase")(e.holidayName):a=!1;return a}}}]).factory("OrderSchedulesFactory",[function(){return function(e){var r=e._id;if(!r)return"";var t=r.substring(0,2),a=r.substring(3,5),o=r.substring(6,8),n=o+t+a;return n}}]).factory("DateFactory",[function(){return{currentDay:function(){return currentDay=moment(),currentDay.isoWeekday()>5&&currentDay.add(currentDay.isoWeekday()-5,"days"),currentDay},formatDate:function(e){var r=e.format("MMMM D"),t=e.format("dddd");return{todaysDate:r,dayOfWeek:t}}}}]);